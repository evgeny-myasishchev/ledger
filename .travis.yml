language: ruby
cache: bundler
rvm:
- 2.2
sudo: false
addons:
  postgresql: "9.3"
services:
  - docker
cache: bundler  
env: DB_CONFIG=config/database_postgres.yml
before_script:
  - psql -c 'create database ledger_dev;' -U postgres 
  - psql -c 'create database ledger_test;' -U postgres 
  - psql -c 'create database ledger_event_store;' -U postgres 
  - bundle exec rake db:setup
script: bundle exec rspec spec
deploy:
  provider: script
  skip_cleanup: true
  script: ./docker/build-and-publish.sh
  on:
    branch: docker #TODO: New special branch for releases must be created (like stable)
    rvm: 2.2